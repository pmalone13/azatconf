{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "location": {
            "type": "string"
        },
        "jumpboxVmSize": {
            "type": "string",
            "defaultValue": "Standard_B1s",
            "metadata": {
                "description": "The size of the virtual machine used for the jumpbox/bastion host."
            }
        },
        "sshKey": {
            "type": "string",
            "metadata": {
                "description": "The public key for the jumpbox SSH user"
            }
        },
        "sshUserName": {
            "type": "string",
            "defaultValue": "crowdadmin",
            "metadata": {
                "description": "The username used to SSH into the jumpbox."
            }
        },
        "linuxOsType": {
            "type": "string",
            "defaultValue": "Canonical:UbuntuServer:18.04-LTS",
            "allowedValues": [
                "Canonical:UbuntuServer:18.04-LTS",
                "Canonical:0001-com-ubuntu-server-focal:20_04-lts-gen2",
                "Canonical:0001-com-ubuntu-server-jammy:22_04-lts-gen2",
                "RedHat:RHEL:7.5",
                "OpenLogic:CentOS:7.5",
                "credativ:Debian:9-backports"
            ],
            "metadata": {
                "description": "Select your preferred Linux OS type. The selected Linux OS type has to support Accelerated Networking as well - https://docs.microsoft.com/en-us/azure/virtual-network/create-vm-accelerated-networking-cli"
            }
        },
         "osDiskType": {
            "type": "string",
            "defaultValue": "StandardSSD_LRS",
            "allowedValues": [
                "Premium_LRS",
                "StandardSSD_LRS",
                "Standard_LRS",
                "UltraSSD_LRS"
            ],
            "metadata": {
                "description": "The disk type for the Data Disk of each node in the cluster."
            }
        }
    },
    "variables": {
        "namespace": "crd",
        "tags": {
            "vendor": "Atlassian",
            "product": "Crowd",
            "provider": "2F0AF47A-92C7-413A-9009-C3815BFF7AF6"
        },
        "vnet": {
            "name": "[concat(variables('namespace'), 'vnet')]",
            "prefix": "10.0.0.0/16"
        },
        "gtwySubnet": {
            "name": "[concat(variables('namespace'), 'appgwsubnet')]",
            "prefix": "10.0.1.0/24"
        },
        "appSubnet": {
            "name": "[concat(variables('namespace'), 'cluster', 'subnet')]",
            "prefix": "10.0.2.0/27",
            "nsg": {
                "name": "[concat(variables('namespace'), 'cluster', 'nsg')]"
            }
        },
        "jumpbox": {
            "name": "[concat(variables('namespace'), 'jumpbox')]",
            "nsg": {
                "name": "[concat(variables('namespace'), 'jumpbox', 'nsg')]"
            },
            "vm": {
                "size": "[parameters('jumpboxVmSize')]",
                "user": "[parameters('sshUserName')]",
                "key": "[parameters('sshKey')]",
                "image": {
                    "publisher": "[split(parameters('linuxOsType'), ':')[0]]",
                    "offer": "[split(parameters('linuxOsType'), ':')[1]]",
                    "sku": "[split(parameters('linuxOsType'), ':')[2]]",
                    "version": "latest"
                },
                "disk": {
                    "name": "[concat(variables('namespace'), 'jumpbox', 'osdisk')]",
                    "type": "[parameters('osDiskType')]"
                }
            },
            "ip": {
                "name": "[concat(variables('namespace'), '-jumpboxip-', uniqueString(resourceGroup().id))]"
            },
            "subnet": {
                "name": "[concat(variables('namespace'), 'jumpboxsubnet')]",
                "prefix": "10.0.3.0/24"
            },
            "nics": {
                "public": "[concat(variables('namespace'), 'jumpbox', 'nic', 'public')]"
            }
        },
        "names" : {
            "jumpBox" : "[concat('Microsoft.Network/publicIPAddresses', '/', variables('jumpbox').ip.name)]",
            "ip" : "[concat('Microsoft.Network/publicIPAddresses', '/', variables('jumpbox').ip.name)]",
            "nsg": "[concat('Microsoft.Network/networkSecurityGroups/', variables('appSubnet').nsg.name)]",
            "vnet": "[concat('Microsoft.Network/virtualNetworks/', variables('vnet').name)]",
            "nics": "[concat('Microsoft.Network/networkInterfaces/', variables('jumpbox').nics.public)]"
        }
    },
    "resources": [
        {
            "type": "Microsoft.Network/networkSecurityGroups",
            "apiVersion": "2022-01-01",
            "name": "[variables('appSubnet').nsg.name]",
            "location": "[parameters('location')]",
            "tags": "[variables('tags')]",
            "dependsOn": [
                "[variables('names').jumpBox]"
            ],
            "properties": {
                "securityRules": [
                    {
                        "name": "allow_http",
                        "properties": {
                            "description": "Allow http traffic.",
                            "protocol": "Tcp",
                            "sourcePortRange": "*",
                            "destinationPortRange": "8080",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "*",
                            "access": "Allow",
                            "priority": 101,
                            "direction": "Inbound"
                        }
                    },
                    {
                        "name": "allow_ssh_from_jumpbox",
                        "properties": {
                            "description": "Allow ssh trafic from single node in internal subnet",
                            "protocol": "Tcp",
                            "sourcePortRange": "*",
                            "sourceAddressPrefix": "[reference(variables('jumpbox').ip.name).ipAddress]",
                            "destinationPortRange": "22",
                            "destinationAddressPrefix": "*",
                            "access": "Allow",
                            "priority": 103,
                            "direction": "Inbound"
                        }
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Network/networkSecurityGroups",
            "apiVersion": "2022-01-01",
            "name": "[variables('jumpbox').nsg.name]",
            "location": "[parameters('location')]",
            "tags": "[variables('tags')]",
            "dependsOn": [
                 "[variables('names').ip]"
            ],
            "properties": {
                "securityRules": [
                    {
                        "name": "allow_ssh_from_jumpbox",
                        "properties": {
                            "description": "Allow ssh trafic to the jumpbox",
                            "protocol": "Tcp",
                            "sourcePortRange": "*",
                            "sourceAddressPrefix": "*",
                            "destinationPortRange": "22",
                            "destinationAddressPrefix": "*",
                            "access": "Allow",
                            "priority": 102,
                            "direction": "Inbound"
                        }
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Network/publicIPAddresses",
            "apiVersion": "2022-01-01",
            "name": "[variables('jumpbox').ip.name]",
            "location": "[parameters('location')]",
            "tags": "[variables('tags')]",
            "properties": {
                "publicIPAllocationMethod": "Static",
                "dnsSettings": {
                    "domainNameLabel": "[variables('jumpbox').ip.name]"
                }
            }
        },
        {
            "type": "Microsoft.Network/virtualNetworks",
            "apiVersion": "2022-01-01",
            "name": "[variables('vnet').name]",
            "location": "[parameters('location')]",
            "tags": "[variables('tags')]",
            "dependsOn": [
                "[variables('names').nsg]"
            ],
            "properties": {
                "addressSpace": {
                    "addressPrefixes": [
                        "[variables('vnet').prefix]"
                    ]
                },
                "subnets": [
                    {
                        "name": "[variables('gtwySubnet').name]",
                        "properties": {
                            "addressPrefix": "[variables('gtwySubnet').prefix]"
                        }
                    },
                    {
                        "name": "[variables('appSubnet').name]",
                        "properties": {
                            "addressPrefix": "[variables('appSubnet').prefix]",
                            "networkSecurityGroup": {
                                "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('appSubnet').nsg.name)]"
                            },
                            "serviceEndpoints": [
                                {
                                    "service": "Microsoft.Sql",
                                    "locations": [
                                        "[parameters('location')]"
                                    ]
                                }
                            ]
                        }
                    },
                    {
                        "name": "[variables('jumpbox').subnet.name]",
                        "properties": {
                            "addressPrefix": "[variables('jumpbox').subnet.prefix]",
                            "networkSecurityGroup": {
                                "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('jumpbox').nsg.name)]"
                            }
                        }
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Network/networkInterfaces",
            "apiVersion": "2022-01-01",
            "name": "[variables('jumpbox').nics.public]",
            "location": "[parameters('location')]",
            "tags": "[variables('tags')]",
            "dependsOn": [
                 "[variables('names').ip]",
                 "[variables('names').vnet]"
            ],
            "properties": {
                "networkSecurityGroup": {
                    "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('jumpbox').nsg.name)]"
                },
                "ipConfigurations": [
                    {
                        "name": "public-access",
                        "properties": {
                            "publicIPAddress": {
                                "id": "[resourceId('Microsoft.Network/publicIPAddresses/', variables('jumpbox').ip.name)]"
                            },
                            "subnet": {
                                "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets/', variables('vnet').name, variables('jumpbox').subnet.name)]"
                            }
                        }
                    }
                ],
                "enableIPForwarding": true
            }
        },
        {
            "type": "Microsoft.Compute/virtualMachines",
            "apiVersion": "2022-03-01",
            "name": "[variables('jumpbox').name]",
            "location": "[parameters('location')]",
            "tags": "[variables('tags')]",
            "dependsOn": [
                "[variables('names').nics]"
            ],
            "properties": {
                "hardwareProfile": {
                    "vmSize": "[variables('jumpbox').vm.size]"
                },
                "osProfile": {
                    "computerName": "[variables('jumpbox').ip.name]",
                    "adminUsername": "[variables('jumpbox').vm.user]",
                    "linuxConfiguration": {
                        "disablePasswordAuthentication": true,
                        "ssh": {
                            "publicKeys": [
                                {
                                    "path": "[concat('/home/', variables('jumpbox').vm.user, '/.ssh/authorized_keys')]",
                                    "keyData": "[variables('jumpbox').vm.key]"
                                }
                            ]
                        }
                    }
                },
                "storageProfile": {
                    "imageReference": {
                        "publisher": "[variables('jumpbox').vm.image.publisher]",
                        "offer": "[variables('jumpbox').vm.image.offer]",
                        "sku": "[variables('jumpbox').vm.image.sku]",
                        "version": "[variables('jumpbox').vm.image.version]"
                    },
                    "osDisk": {
                        "name": "[variables('jumpbox').vm.disk.name]",
                        "managedDisk": {
                            "storageAccountType": "[variables('jumpbox').vm.disk.type]"
                        },
                        "createOption": "FromImage"
                    }
                },
                "networkProfile": {
                    "networkInterfaces": [
                        {
                            "id": "[resourceId('Microsoft.Network/networkInterfaces/', variables('jumpbox').nics.public)]"
                        }
                    ]
                }
            }
        }
    ],
    "outputs": {
        "vnetName": {
            "type": "string",
            "value": "[variables('vnet').name]"
        },
        "appSubnetName": {
            "type": "string",
            "value": "[variables('appSubnet').name]"
        },
        "gtwySubnetName": {
            "type": "string",
            "value": "[variables('gtwySubnet').name]"
        },
        "jumpboxName": {
            "type": "string",
            "value": "[variables('jumpbox').name]"
        },
        "jumpboxPublicIpAddress": {
            "type": "string",
            "value": "[reference(variables('jumpbox').ip.name).ipAddress]"
        },
        "jumpboxPublicEndpoint": {
            "type": "string",
            "value": "[reference(variables('jumpbox').ip.name).dnsSettings.fqdn]"
        },
        "jumpboxDns": {
            "type": "string",
            "value": "[variables('jumpbox').ip.name]"
        },
        "sshServer": {
            "type": "string",
            "value": "[concat('ssh ', variables('jumpbox').vm.user, '@', reference(variables('jumpbox').ip.name).dnsSettings.fqdn)]"
        }
    }
}